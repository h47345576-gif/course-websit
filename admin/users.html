<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="stylesheet" href="admin.css">
    <style>
        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .users-table th,
        .users-table td {
            padding: 15px 20px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .users-table th {
            background: var(--light);
            color: var(--gray);
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light);
        }

        .role-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .role-admin {
            background: #e0e7ff;
            color: var(--primary);
        }

        .role-teacher {
            background: #dcfce7;
            color: var(--success);
        }

        .role-student {
            background: #f3f4f6;
            color: var(--gray);
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 3px;
        }

        .btn-edit {
            background: var(--light);
            color: var(--primary);
        }

        .btn-delete {
            background: #fee2e2;
            color: var(--danger);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border, #e5e7eb);
            border-radius: 8px;
            font-family: inherit;
        }
    </style>
</head>

<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="logo-icon">ğŸ“š</span>
            <span class="logo-text">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
        </div>
        <nav class="sidebar-nav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </a>
            <a href="users.html" class="nav-item active">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</span>
            </a>
            <a href="courses.html" class="nav-item">
                <span class="nav-icon">ğŸ“š</span>
                <span>Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</span>
            </a>
            <a href="payments.html" class="nav-item">
                <span class="nav-icon">ğŸ’°</span>
                <span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</span>
            </a>
            <a href="settings.html" class="nav-item">
                <span class="nav-icon">âš™ï¸</span>
                <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <a href="../index.html" class="nav-item">
                <span class="nav-icon">ğŸŒ</span>
                <span>Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
            </a>
            <button class="nav-item logout-btn" onclick="logout()">
                <span class="nav-icon">ğŸšª</span>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <button class="menu-toggle" id="menuToggle">â˜°</button>
            <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>
            <button class="btn-primary" onclick="openAddUserModal()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
        </header>

        <div class="dashboard">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                        <th>Ø§Ù„Ø¯ÙˆØ±</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="5" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Add/Edit User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <h2 id="userModalTitle" style="margin-bottom: 20px;">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2>
            <form id="userForm">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù…</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" name="password" placeholder="Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ±">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¯ÙˆØ±</label>
                    <select name="role">
                        <option value="student">Ø·Ø§Ù„Ø¨</option>
                        <option value="teacher">Ù…Ø¹Ù„Ù…</option>
                        <option value="admin">Ù…Ø¯ÙŠØ±</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn-primary" style="flex: 1">Ø­ÙØ¸</button>
                    <button type="button" class="btn-link" onclick="closeUserModal()"
                        style="flex: 1; background: var(--light); border-radius: 8px;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="admin.js"></script>
    <script>
        // Users data (will be loaded from API)
        let users = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });

        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            try {
                // Try to fetch users from API
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE_URL}/api/v1/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    users = data.results || data || [];
                } else {
                    // Fallback to mock data
                    users = [
                        { id: 1, name: 'Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±', email: 'admin@platform.com', role: 'admin', created_at: '2026-01-26' },
                        { id: 2, name: 'Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£Ø³ØªØ§Ø°', email: 'teacher1@platform.com', role: 'teacher', created_at: '2026-01-26' },
                        { id: 3, name: 'Ø¹Ù„ÙŠ Ø§Ù„Ø·Ø§Ù„Ø¨', email: 'student1@gmail.com', role: 'student', created_at: '2026-01-26' }
                    ];
                }

                renderUsers();
            } catch (error) {
                // Fallback to mock data
                users = [
                    { id: 1, name: 'Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±', email: 'admin@platform.com', role: 'admin', created_at: '2026-01-26' },
                    { id: 2, name: 'Ù…Ø­Ù…Ø¯ Ø§Ù„Ø£Ø³ØªØ§Ø°', email: 'teacher1@platform.com', role: 'teacher', created_at: '2026-01-26' },
                    { id: 3, name: 'Ø¹Ù„ÙŠ Ø§Ù„Ø·Ø§Ù„Ø¨', email: 'student1@gmail.com', role: 'student', created_at: '2026-01-26' }
                ];
                renderUsers();
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            const roleLabels = { admin: 'Ù…Ø¯ÙŠØ±', teacher: 'Ù…Ø¹Ù„Ù…', student: 'Ø·Ø§Ù„Ø¨' };

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <div class="user-info">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}" class="user-avatar">
                            <span>${user.name}</span>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td><span class="role-badge role-${user.role}">${roleLabels[user.role] || user.role}</span></td>
                    <td>${user.created_at}</td>
                    <td>
                        <button class="btn-action btn-edit" onclick="editUser(${user.id})">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-action btn-delete" onclick="deleteUser(${user.id})">Ø­Ø°Ù</button>
                    </td>
                </tr>
            `).join('');
        }

        function openAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
            document.getElementById('userForm').reset();
            delete document.getElementById('userForm').dataset.userId;
            document.getElementById('userModal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                document.getElementById('userModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
                document.querySelector('#userForm [name="name"]').value = user.name;
                document.querySelector('#userForm [name="email"]').value = user.email;
                document.querySelector('#userForm [name="password"]').value = '';
                document.querySelector('#userForm [name="role"]').value = user.role;
                document.getElementById('userForm').dataset.userId = id;
                document.getElementById('userModal').classList.add('active');
            }
        }

        async function deleteUser(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                try {
                    const token = localStorage.getItem('auth_token');
                    const response = await fetch(`${API_BASE_URL}/api/v1/users/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!');
                        loadUsers();
                    } else {
                        const err = await response.json();
                        alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + (err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                    }
                } catch (error) {
                    // For demo, remove from local array
                    users = users.filter(u => u.id !== id);
                    renderUsers();
                    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…!');
                }
            }
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const userId = form.dataset.userId;
            const formData = {
                name: form.name.value,
                email: form.email.value,
                role: form.role.value
            };
            if (form.password.value) {
                formData.password = form.password.value;
            }

            try {
                const token = localStorage.getItem('auth_token');
                const url = userId
                    ? `${API_BASE_URL}/api/v1/users/${userId}`
                    : `${API_BASE_URL}/api/v1/users`;
                const method = userId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert(userId ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!');
                    closeUserModal();
                    loadUsers();
                } else {
                    const err = await response.json();
                    alert('ÙØ´Ù„: ' + (err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            } catch (error) {
                // For demo, add to local array
                if (!userId) {
                    users.push({
                        id: Date.now(),
                        ...formData,
                        created_at: new Date().toISOString().split('T')[0]
                    });
                } else {
                    const idx = users.findIndex(u => u.id == userId);
                    if (idx !== -1) {
                        users[idx] = { ...users[idx], ...formData };
                    }
                }
                renderUsers();
                closeUserModal();
                alert(userId ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…!' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…!');
            }
        });
    </script>
</body>

</html>